<html>

<head>
  <title>Oregon</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link href="https://fonts.googleapis.com/css?family=Space+Mono" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="/javascripts/term.js"></script>
</head>

<body class="blue-grey darken-4">
  <div id="term-page">
    <nav class="blue-grey darken-3">
      <div class="nav-wrapper">
        <a href="#" class="brand-logo center">Oregon</a>
        <ul id="nav-mobile" class="left">
          <li><a href="#">About</a></li>
        </ul>
        <ul class="right">
          <li><a href="#"><i class="material-icons">menu</i></a></li>
        </ul>
      </div>
    </nav>
    <div class="info blue-grey darken-2"></div>
    <div class="page-contain white-text">
      <div class="roundscreen">
        <!-- <div class="window-header blue darken-2">
          Oregon
        </div> -->
        <div class="text-contain">
          <p v-for="line in main.lines">
            <template v-if="line.type === 'input'">
              <span class="grey-text text-darken-2">> </span>
              <span class="input">{{ line.text }}<span v-if="line.active" class="cursor">_</span></span>
            </template>
            <template v-else-if="line.type === 'output'">
              <span class="grey-text text-darken-2">~$ </span>
              <span class="written">{{ line.text }}</span>
            </template>
            <span v-else><br></span>
          </p>
        </div>
      </div>
    </div>
  </div>
</body>

<script type="text/javascript">
  const LINES = 30
  var main = new Term()
  var data = {
    main: main,
    game: {

    },
    player: {

    }
  }

  var methods = {
    hunt: function (term) {
      hunt = game.actions.hunt
      prompt = Math.floor(Math.random() * hunt.prompts.length)
      // TODO
    },
    move: async function () {
      data.player = await axios.get('/' + game.sn + '/next')
    }
  }

  var vm = new Vue({
    el: '#term-page',
    data: data,
    methods: methods
  })

  async function playTurn(term) {
    term.writeLine('You are in ' + player.location + ' at mile marker ' + player.miles)
    term.writeLine('Would you like to:')
    var locName = player.location
    var game = data.game
    var loc_features = game.locations[location].features
    var game_features = game.features
    loc_features.foreach(function (e, i) {
      term.writeLine('(' + (i + 1) + ') ' + e.description)
    })
    var response = 0
    do {
      if(response) term.writeLine('Invalid choice. Please enter one of the displayed numbers and press enter.')
      response = Number.parseInt(await term.readLine())
    } while(response < 0 || response > features.length)
    // Look up the function in game.features based on the location indicated by the response:
    await methods[game_features[loc_features[response - 1]].fun](term)
  }

  async function loadGame(sn) {
    try {
      data.player = (await axios.get('/' + sn)).data
      return true
    } catch(e) {
      return false
    }
  }

  async function newGame() {
    data.player = (await axios.get('/new' + sn)).data
  }


  async function startGame(term) {
    term.writeLines([
      'Greetings traveller!',
      'Would you like to',
      '(1) Start a new journey',
      '(2) Continue your travels'
    ])
    data.game = await axios.get('/game.json')
    var choice = await data.main.readLine()
    if (choice === '1') {
      term.writeLine('One moment while your game is created...')
      term.writeLine('Your Save Number is ' + await newGame())
    } else if (choice === '2') {
      term.writeLine('Excellent, please enter your Save Number below:')
      var sn = await term.readLine()
      var success = false
      while (!success) {
        try {
          success = await loadGame(sn)
        } catch (e) {
          term.writeLine('Invalid save number: "' + sn + '"')
          term.writeLine('Please enter your Save Number below:')
          sn = await term.readLine()
          console.error(e)
        }
      }
      while (true) {
        await playTurn(term)
      }
    } else {
      term.writeLine('Invalid response. Options are "1" or "2"')
      await startGame(term)
    }
  }

  startGame(main).then(function () {

  }).catch(function (e) {
    alert('Something went wrong. Please write down your save number if you have one, then reload the page.')
    console.error(e)
  })
</script>

</html>